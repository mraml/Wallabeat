<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Wallabeat — Tempest‑Inspired Drum Synth</title>
<style>
  :root{
    --bg:#0f1722;--panel:#121b28;--panel2:#162235;--muted:#7c91b1;
    --fg:#d9e2f2;--accent:#19b6ff;--accent2:#00d2a8;--warning:#ff7a7a;
    --shadow:0 10px 24px rgba(0,0,0,.35);
  }
  *{box-sizing:border-box;font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
  html,body{margin:0;background:radial-gradient(1200px 600px at 70% -200px,#162235 0%,#0f1722 60%);color:var(--fg)}
  .wrap{max-width:1100px;margin:24px auto 80px;padding:0 16px}
  header{
    display:flex;align-items:center;gap:16px;margin-bottom:16px; flex-wrap: wrap;
  }
  .brand{font-weight:900;font-size:34px;letter-spacing:.2px;color:#40c9ff;text-shadow:0 2px 0 rgba(0,0,0,.35)}
  .sp{flex:1}
  .chip{display:inline-flex;align-items:center;gap:10px;background:var(--panel2);padding:8px 12px;border-radius:14px;box-shadow:var(--shadow)}
  .chip small{opacity:.75}
  .knobrow{display:flex;gap:14px;align-items:center;flex-wrap:wrap}
  .hdr-knobs .knob{--size:56px}
  .btn{
    background:#1f2b40;border:0;color:var(--fg);padding:12px 22px;border-radius:999px;
    font-weight:700;box-shadow:var(--shadow);cursor:pointer;transition:.15s transform,.15s background; user-select: none;
  }
  .btn:active{transform:translateY(1px)}
  .btn.play{background:linear-gradient(180deg,#26d2ff,#1485ff)}
  .btn.stop{background:linear-gradient(180deg,#ff9a9a,#ff5d5d)}
  .btn.reverse.active{background:var(--accent2); color: var(--bg);}
  .btn.stutter.active{background:var(--accent); color: var(--bg); transform: translateY(1px);}
  .panel{
    background:linear-gradient(180deg,#121b28,#0f1722);border-radius:18px;padding:16px;box-shadow:var(--shadow);margin:12px 0
  }
  .title{font-weight:800;opacity:.95;margin:2px 0 10px 0}
  .block{background:var(--panel2);border-radius:14px;padding:12px}
  .block .label{font-size:12px;color:var(--muted);margin-top:8px;text-align:center}
  .row{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
  .preset{display:flex;align-items:center;gap:8px}
  .preset .presetname{background:#0e1522;border:1px solid #1f2b40;color:#bfe4ff;border-radius:10px;padding:8px 16px;min-width:140px;text-align:center}
  .preset .mini{width:36px;height:36px;border-radius:10px;background:#1f2b40;color:#cde8ff;border:0;font-weight:900;cursor:pointer}
  .preset .tri{width:42px;height:42px;border-radius:12px;background:#19b6ff;color:#001a2a;border:0;font-weight:900;cursor:pointer}
  .tabs{display:flex;gap:8px}
  .tab{background:#1a2538;border:0;color:#a2b7d8;padding:6px 10px;border-radius:10px;cursor:pointer}
  .tab.active{background:#2a3957;color:#e8f2ff}
  /* Tracks */
  .tracks{display:grid;grid-template-columns:repeat(8,1fr);gap:12px}
  @media(max-width:820px){.tracks{grid-template-columns:repeat(4,1fr)}}
  .trk-pad{
    background:linear-gradient(180deg, #2a3957, #1a2538);
    border-radius:14px; padding:12px; text-align:center;
    font-weight: 700; cursor: pointer;
    box-shadow: var(--shadow);
    position: relative;
    user-select: none;
  }
  .trk-pad.active{outline:2px solid var(--accent); background: var(--accent); color: var(--bg);}
  .trk-pad .mute-btn {
    position: absolute;
    top: 6px; right: 6px;
    width: 24px; height: 24px;
    border-radius: 50%;
    border: 0;
    background: #1f2b40;
    color: var(--muted);
    font-weight: bold;
    cursor: pointer;
    z-index: 10;
  }
  .trk-pad.muted .mute-btn { background: var(--warning); color: white; }
  .trk-pad.muted .track-name { opacity: 0.5; }

  /* Sequencer */
  .seq{display:grid;grid-template-columns:repeat(8,1fr);gap:12px;margin-top:10px}
  .pad{aspect-ratio:1/1;background:linear-gradient(180deg,#26344c,#1a2540);
       border-radius:14px;display:flex;align-items:flex-end;justify-content:flex-end;padding:6px;position:relative;
       box-shadow: inset 0 2px 8px rgba(0,0,0,.45), var(--shadow);cursor:pointer;user-select:none}
  .pad.on{background:linear-gradient(180deg, var(--accent), #1485ff)}
  .pad.playing{outline:3px solid var(--accent)}
  .pad small{position:absolute;bottom:6px;left:8px;color:#b9c7e3;opacity:.8; font-size: 12px;}
  /* Knobs (rotary range) */
  .knob{
    --size:60px; --track:#26405f; --tick:#7fbaff;
    width:var(--size);height:var(--size);border-radius:50%;
    background:conic-gradient(from -210deg, var(--tick) 0deg 0deg, #1b2a44 0deg 360deg), radial-gradient(circle at 50% 45%, #233653 0 60%, #0e192a 60% 100%);
    position:relative;display:grid;place-items:center;box-shadow:inset 0 4px 9px rgba(0,0,0,.6),0 6px 14px rgba(0,0,0,.35)
  }
  .knob input{position:absolute;inset:0;opacity:0;cursor:pointer}
  .knob .dot{
    width:6px;height:6px;border-radius:50%;background:#bfe4ff;
    transform:rotate(0deg) translateY(calc(-1 * var(--size) / 2.4));
    transform-origin: center;
  }
  .kwrap{display:flex;flex-direction:column;align-items:center;gap:6px;width:86px}
  .kwrap .tag{font-size:12px;color:#a5b8d9;text-align:center}
  .miniSel{display:flex;gap:6px; align-items: center;}
  .miniSel button{background:#21304b;border:0;color:#cde4ff;border-radius:12px;padding:6px 8px;cursor:pointer}
  .miniSel button.sel{background:#2f4671}
  .help{opacity:.7;font-size:12px}
  .param-section { display: flex; gap: 16px; margin-top: 16px; }
  @media(max-width:920px){.param-section{flex-direction: column;}}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="brand">Wallabeat</div>
    <div class="chip"><small>BPM</small>
      <input id="bpm" type="number" min="40" max="240" step="1" value="120"
             style="width:74px;background:#0e1522;border:1px solid #1f2b40;color:#dff0ff;border-radius:10px;padding:8px 10px"/>
    </div>
    <div class="sp"></div>
    <div class="hdr-knobs knobrow">
      <div class="kwrap"><div class="knob" data-id="swing"><span class="dot"></span><input type="range" min="0" max="100" value="0"></div><div class="tag">Swing</div></div>
      <div class="kwrap"><div class="knob" data-id="gvol"><span class="dot"></span><input type="range" min="0" max="100" value="80"></div><div class="tag">Master Vol</div></div>
      <div class="kwrap"><div class="knob" data-id="drive"><span class="dot"></span><input type="range" min="0" max="100" value="10"></div><div class="tag">Overdrive</div></div>
      <div class="kwrap"><div class="knob" data-id="comp"><span class="dot"></span><input type="range" min="0" max="100" value="20"></div><div class="tag">Compression</div></div>
      <div class="kwrap"><div class="knob" data-id="stutterRate"><span class="dot"></span><input type="range" min="0" max="4" value="0" step="1"></div><div class="tag">Stutter Rate</div></div>
    </div>
    <button id="stutterBtn" class="btn stutter">Stutter</button>
    <button id="playBtn" class="btn play">Play</button>
    <button id="stopBtn" class="btn stop">Stop</button>
    <button id="reverseBtn" class="btn reverse">Reverse</button>
  </header>

  <section class="panel">
    <div class="title">Track Parameters: <span id="trackName">Kick</span></div>

    <div class="block" style="display:flex;align-items:center;justify-content:space-between;gap:16px; flex-wrap: wrap;">
      <div class="preset">
        <button id="prevPreset" class="mini">&lt;</button>
        <div id="presetName" class="presetname">Kick</div>
        <button id="nextPreset" class="mini">&gt;</button>
        <button id="audition" class="tri">▶</button>
        <button id="resetBtn" class="btn" style="padding: 8px 16px;">Reset</button>
      </div>
       <div class="miniSel">
            <span class="help">Mute Group</span>
            <div id="muteGroupSel">
                <button data-group="0" class="sel">None</button>
                <button data-group="1">1</button>
                <button data-group="2">2</button>
            </div>
       </div>
    </div>

    <div class="param-section">
        <!-- OSCILLATORS -->
        <div class="block" style="flex: 1.2;">
            <div class="row" style="gap:18px; justify-content: center;">
                <div style="display:flex;gap:10px;align-items:center">
                    <div class="tabs">
                        <button class="tab oscTab active" data-osc="0">OSC 1</button>
                        <button class="tab oscTab" data-osc="1">OSC 2</button>
                    </div>
                    <div class="miniSel" id="waveSel">
                        <button data-wave="sine" class="sel">Sine</button>
                        <button data-wave="square">Square</button>
                        <button data-wave="triangle">Tri</button>
                        <button data-wave="sawtooth">Saw</button>
                        <button data-wave="noise">Noise</button>
                    </div>
                </div>
                <div class="knobrow">
                    <div class="kwrap"><div class="knob" data-id="pitch1"><span class="dot"></span><input type="range" min="-24" max="24" value="0"></div><div class="tag">Pitch</div></div>
                    <div class="kwrap"><div class="knob" data-id="detune1"><span class="dot"></span><input type="range" min="-50" max="50" value="0"></div><div class="tag">Detune</div></div>
                    <div class="kwrap"><div class="knob" data-id="blend"><span class="dot"></span><input type="range" min="0" max="100" value="70"></div><div class="tag">Blend</div></div>
                </div>
            </div>
            <div class="label">Oscillators</div>
        </div>
        <!-- FILTER & ENV -->
        <div class="block" style="flex: 2;">
            <div class="row knobrow" style="justify-content: center;">
                <div class="kwrap"><div class="knob" data-id="lp"><span class="dot"></span><input type="range" min="50" max="20000" value="12000" step="1"></div><div class="tag">LP Cut</div></div>
                <div class="kwrap"><div class="knob" data-id="hp"><span class="dot"></span><input type="range" min="20" max="2000" value="30" step="1"></div><div class="tag">HP Cut</div></div>
                <div class="kwrap"><div class="knob" data-id="res"><span class="dot"></span><input type="range" min="0.1" max="20" step="0.1" value="0.7"></div><div class="tag">Res</div></div>
                <div class="kwrap"><div class="knob" data-id="a"><span class="dot"></span><input type="range" min="0" max="2000" value="2"></div><div class="tag">Attack</div></div>
                <div class="kwrap"><div class="knob" data-id="d"><span class="dot"></span><input type="range" min="1" max="4000" value="80"></div><div class="tag">Decay</div></div>
                <div class="kwrap"><div class="knob" data-id="s"><span class="dot"></span><input type="range" min="0" max="1" step="0.01" value="0.0"></div><div class="tag">Sustain</div></div>
                <div class="kwrap"><div class="knob" data-id="r"><span class="dot"></span><input type="range" min="1" max="4000" value="120"></div><div class="tag">Release</div></div>
            </div>
            <div class="label">Filter & Envelope</div>
        </div>
        <!-- MIX & FX -->
        <div class="block" style="flex: 2;">
            <div class="row knobrow" style="justify-content: center;">
                <div class="kwrap"><div class="knob" data-id="pan"><span class="dot"></span><input type="range" min="-1" max="1" step="0.01" value="0"></div><div class="tag">Pan</div></div>
                <div class="kwrap"><div class="knob" data-id="reverbSend"><span class="dot"></span><input type="range" min="0" max="1" step="0.01" value="0"></div><div class="tag">Reverb</div></div>
                <div class="kwrap"><div class="knob" data-id="delaySend"><span class="dot"></span><input type="range" min="0" max="1" step="0.01" value="0"></div><div class="tag">Delay</div></div>
                <div class="kwrap"><div class="knob" data-id="delayTime"><span class="dot"></span><input type="range" min="0.01" max="1" step="0.01" value="0.25"></div><div class="tag">Dly Time</div></div>
                <div class="kwrap"><div class="knob" data-id="delayFb"><span class="dot"></span><input type="range" min="0" max="0.9" step="0.01" value="0.3"></div><div class="tag">Dly FB</div></div>
            </div>
            <div class="label">Mix & Effects</div>
        </div>
    </div>
  </section>

  <section class="panel">
    <div class="title">Tracks</div>
    <div id="tracks" class="tracks"></div>
  </section>

  <section class="panel">
    <div class="title">Sequencer</div>
    <div id="seq" class="seq"></div>
  </section>

</div>

<script>
/* ---------- Utilities: rotary visuals ---------- */
function initKnobs() {
    document.querySelectorAll('.knob').forEach(k=>{
      const input=k.querySelector('input');
      const dot=k.querySelector('.dot');
      const update=()=>{
        const min=+input.min, max=+input.max, val=+input.value;
        const pct=(val-min)/(max-min);
        const deg = -210 + pct * 240;
        dot.style.transform=`rotate(${deg}deg) translateY(calc(-1 * var(--size) / 2.4))`;
      };
      input.addEventListener('input',update);
      input.dispatchEvent(new Event('input'));
    });
}
initKnobs();

/* ---------- Audio Engine ---------- */
const AudioCtx=window.AudioContext||window.webkitAudioContext;
const ctx=new AudioCtx();
let masterGain=ctx.createGain(); masterGain.gain.value=0.8;
let driveNode=ctx.createWaveShaper();
let comp=ctx.createDynamicsCompressor();
let activeVoices = [null, null, null]; // For mute groups 1 and 2

masterGain.connect(driveNode);
driveNode.connect(comp);
comp.connect(ctx.destination);

function setDrive(amount){
    const k=amount*2+1; const n=44100; const curve=new Float32Array(n);
    for(let i=0;i<n;i++){ const x=i*2/n-1; curve[i]=Math.tanh(k*x); }
    driveNode.curve=curve;
}
function setComp(amount) {
    comp.threshold.value = -50 + (1-amount) * 50;
    comp.ratio.value = 1 + amount * 19;
}

function makeImpulse(len=2,decay=0.4){
  const rate=ctx.sampleRate; const length=rate*len; const ir=ctx.createBuffer(2,length,rate);
  for(let ch=0; ch<2; ch++){
    const data=ir.getChannelData(ch);
    for(let i=0;i<length;i++){data[i]=(Math.random()*2-1)*Math.pow(1-i/length, decay);}
  } return ir;
}
const impulseBuffer = makeImpulse(2.2, 0.5);

const trackFX = [...Array(8)].map(() => {
    const reverb = ctx.createConvolver(); reverb.buffer = impulseBuffer;
    const reverbSend = ctx.createGain(); reverbSend.gain.value = 0;
    reverbSend.connect(reverb).connect(masterGain);

    const delay = ctx.createDelay(1.0); const delayFb = ctx.createGain();
    const delaySend = ctx.createGain(); delaySend.gain.value = 0;
    delaySend.connect(delay); delay.connect(delayFb).connect(delay);
    delay.connect(masterGain);
    return { reverbSend, delay, delayFb, delaySend };
});

function triggerVoice(track, trackIndex, when=ctx.currentTime){
  const p=track.params;
  const vGain=ctx.createGain();

  // Mute Group Logic
  const mg = p.muteGroup;
  if (mg > 0) {
      if (activeVoices[mg]) {
          activeVoices[mg].gain.cancelScheduledValues(when);
          activeVoices[mg].gain.setValueAtTime(activeVoices[mg].gain.value, when);
          activeVoices[mg].gain.linearRampToValueAtTime(0, when + 0.01);
      }
      activeVoices[mg] = vGain;
  }

  const panner=ctx.createStereoPanner(); panner.pan.value=p.pan;
  const hp=ctx.createBiquadFilter(); hp.type='highpass'; hp.frequency.value=p.hp; hp.Q.value=0.7;
  const lp=ctx.createBiquadFilter(); lp.type='lowpass'; lp.frequency.value=p.lp; lp.Q.value=p.res;
  const mix=ctx.createGain(); mix.gain.value=1;
  const sources=[];
  for(let i=0;i<2;i++){
    const oscCfg=p.osc[i];
    let src;
    if(oscCfg.wave==='noise'){
      const b=ctx.createBuffer(1, ctx.sampleRate*2, ctx.sampleRate);
      const data=b.getChannelData(0); for(let k=0;k<data.length;k++) data[k]=Math.random()*2-1;
      src=ctx.createBufferSource(); src.buffer=b; src.loop=true;
    }else{
      src=ctx.createOscillator(); src.type=oscCfg.wave;
      const base= 55 * Math.pow(2,(p.pitch1)/12);
      src.frequency.value = base;
      src.detune.value = (i===0 ? p.detune1 : -p.detune1);
    }
    const g=ctx.createGain();
    g.gain.value = (i===0? (p.blend/100) : (1-p.blend/100));
    src.connect(g).connect(mix);
    sources.push(src);
  }

  const now=when;
  const a=p.a/1000, d=p.d/1000, s=p.s, r=p.r/1000;
  vGain.gain.cancelScheduledValues(now);
  vGain.gain.setValueAtTime(0, now);
  vGain.gain.linearRampToValueAtTime(1, now+a);
  vGain.gain.linearRampToValueAtTime(s, now+a+d);
  vGain.gain.linearRampToValueAtTime(0, now+a+d+r);

  mix.connect(hp).connect(lp).connect(vGain).connect(panner).connect(masterGain);
  const fx = trackFX[trackIndex];
  panner.connect(fx.reverbSend);
  panner.connect(fx.delaySend);

  sources.forEach(s=>{if(s.start) s.start(now);});
  const stopAt=now+a+d+r+0.1;
  sources.forEach(s=>{if(s.stop) s.stop(stopAt);});
  
  if (mg > 0) {
      setTimeout(() => {
          if (activeVoices[mg] === vGain) activeVoices[mg] = null;
      }, (stopAt - ctx.currentTime) * 1000);
  }
}

/* ---------- Model & Presets ---------- */
const defaultParams=()=>({
  osc:[{wave:'sine'},{wave:'square'}], pitch1:0, detune1:0, blend:70,
  lp:12000, hp:30, res:0.7, a:2,d:80,s:0,r:120, pan:0,
  reverbSend: 0, delaySend: 0, delayTime: 0.25, delayFb: 0.3,
  muted:false, steps:Array(16).fill(false), name:'New Sound', muteGroup: 0
});

const soundPresets = [
    { name: 'Kick', pitch1: -12, d: 250, r: 250, lp: 400, blend: 100, osc: [{wave: 'sine'}, {wave: 'sine'}] },
    { name: 'Snare', blend: 20, d: 120, r: 120, hp: 200, lp: 8000, osc: [{wave: 'noise'}, {wave: 'triangle'}] },
    { name: 'Hat Closed', pitch1: 12, d: 50, r: 50, hp: 6000, osc: [{wave: 'noise'}, {wave: 'noise'}], muteGroup: 1 },
    { name: 'Hat Open', pitch1: 12, d: 400, r: 400, hp: 5000, osc: [{wave: 'noise'}, {wave: 'square'}], muteGroup: 1 },
    { name: 'Tom Lo', pitch1: -5, d: 250, r: 250, lp: 1500, osc: [{wave: 'triangle'}, {wave: 'sine'}] },
    { name: 'Tom Mid', pitch1: 0, d: 200, r: 200, lp: 2000, osc: [{wave: 'triangle'}, {wave: 'sine'}] },
    { name: 'Tom Hi', pitch1: 5, d: 150, r: 150, lp: 2500, osc: [{wave: 'triangle'}, {wave: 'sine'}] },
    { name: 'Crash', pitch1: 16, d: 1200, r: 1200, hp: 4000, lp: 15000, osc: [{wave: 'noise'}, {wave: 'square'}], blend: 70 },
    { name: 'Clap', blend: 50, d: 90, r: 90, hp: 1000, lp: 9000, osc: [{wave: 'noise'}, {wave: 'noise'}] },
    { name: 'Rimshot', pitch1: 12, d: 60, r: 60, lp: 4000, hp: 1000, osc: [{wave: 'square'}, {wave: 'square'}] },
    { name: 'Cowbell', pitch1: 7, detune1: 25, d: 150, r: 150, lp: 10000, osc: [{wave: 'square'}, {wave: 'square'}], blend: 50 },
    { name: 'Zap', pitch1: -12, d: 200, r: 200, lp: 2000, res: 15, osc: [{wave: 'sawtooth'}, {wave: 'sawtooth'}] }
];

let currentPresetIndex = 0;
let tracks = [];
let initialKit = [];

function initTracksWithKit() {
    initialKit = soundPresets.slice(0, 8).map(p => ({ ...defaultParams(), ...p }));
    tracks = initialKit.map(p => ({ params: JSON.parse(JSON.stringify(p)) })); // Deep copy
    currentTrack = 0;
    applyParamsToUI();
    renderTracks();
    highlightSteps();
}

/* ---------- UI Management ---------- */
const tracksDiv=document.getElementById('tracks');
const seqDiv=document.getElementById('seq');
const uiKnobs = {};
document.querySelectorAll('.knob').forEach(k => { uiKnobs[k.dataset.id] = k.querySelector('input'); });

function applyParamsToUI() {
    if (!tracks.length) return;
    const p = tracks[currentTrack].params;
    for (const key in p) {
        if (uiKnobs[key]) {
            uiKnobs[key].value = p[key];
            uiKnobs[key].dispatchEvent(new Event('input'));
        }
    }
    const currentOsc = document.querySelector('.oscTab.active').dataset.osc;
    document.querySelectorAll('#waveSel button').forEach(b => {
        b.classList.toggle('sel', b.dataset.wave === p.osc[currentOsc].wave);
    });
    document.querySelectorAll('#muteGroupSel button').forEach(b => {
        b.classList.toggle('sel', +b.dataset.group === p.muteGroup);
    });
    document.getElementById('trackName').textContent = p.name;
    document.getElementById('presetName').textContent = p.name;
}

function updateParamFromUI(param, value) {
    const p = tracks[currentTrack].params;
    p[param] = value;
    const fx = trackFX[currentTrack];
    if (param === 'reverbSend') fx.reverbSend.gain.value = value;
    if (param === 'delaySend') fx.delaySend.gain.value = value;
    if (param === 'delayTime') fx.delay.delayTime.value = value;
    if (param === 'delayFb') fx.delayFb.gain.value = value;
}

function renderTracks(){
  tracksDiv.innerHTML='';
  tracks.forEach((t,i)=>{
    const el=document.createElement('div');
    el.className='trk-pad';
    el.classList.toggle('active', i === currentTrack);
    el.classList.toggle('muted', t.params.muted);
    el.innerHTML=`<div class="track-name">${t.params.name}</div><button class="mute-btn">M</button>`;
    el.addEventListener('click', e => {
      if (e.target.classList.contains('mute-btn')) {
        t.params.muted = !t.params.muted;
        renderTracks();
        return;
      }
      currentTrack=i;
      applyParamsToUI();
      renderTracks();
      highlightSteps();
    });
    tracksDiv.appendChild(el);
  });
}

function renderSeq(){
  seqDiv.innerHTML='';
  for(let i=0;i<16;i++){
    const pad=document.createElement('div'); pad.className='pad';
    pad.innerHTML=`<small>${i+1}</small>`;
    pad.addEventListener('click',()=>{
      const st=tracks[currentTrack].params.steps;
      st[i]=!st[i]; pad.classList.toggle('on',st[i]);
    });
    seqDiv.appendChild(pad);
  }
  highlightSteps();
}
function highlightSteps(){
  if (!tracks.length) return;
  const st=tracks[currentTrack].params.steps;
  [...seqDiv.children].forEach((p,i)=>p.classList.toggle('on',!!st[i]));
}

/* ---------- Transport / clock ---------- */
let isPlaying=false, isReversed=false, step=0, lastTick=0, swing=0, timer=0;
let isStuttering = false, stutterStartStep = 0, stutterRate = 1;
const stutterRates = [1, 2, 4, 8, 16]; // 1=16th, 2=8th, 4=quarter, etc.

function schedule(){
  const bpm=+document.getElementById('bpm').value;
  const spb=60/bpm; const stepDur=spb/4;
  const swingAmt = (swing / 100) * stepDur * 0.5;
  const now=ctx.currentTime;

  while(lastTick < now + 0.1){
    const absoluteStep = step % 16;
    let seqPos;

    if (isStuttering) {
        const stutterLen = stutterRates[stutterRate];
        const stutterOffset = (step - stutterStartStep) % stutterLen;
        seqPos = (stutterStartStep + stutterOffset) % 16;
    } else {
        seqPos = isReversed ? 15 - absoluteStep : absoluteStep;
    }

    const timeAt = lastTick + ((step % 2) ? swingAmt : -swingAmt);
    tracks.forEach((t,ti)=>{
      if(!t.params.muted && t.params.steps[seqPos]) triggerVoice(t, ti, timeAt + stepDur);
    });

    setTimeout(()=>{
      const pads=[...seqDiv.children];
      pads.forEach(p=>p.classList.remove('playing'));
      pads[seqPos].classList.add('playing');
    }, (timeAt - now + stepDur)*1000);

    lastTick += stepDur;
    step++;
  }
  if(isPlaying) timer=requestAnimationFrame(schedule);
}

document.getElementById('playBtn').addEventListener('click',()=>{
  ctx.resume();
  if(!isPlaying){
    isPlaying=true; step=0; lastTick=ctx.currentTime; schedule();
    playBtn.textContent='Pause';
  } else {
    isPlaying = false;
    cancelAnimationFrame(timer);
    playBtn.textContent='Play';
  }
});

document.getElementById('stopBtn').addEventListener('click', () => {
    isPlaying = false; cancelAnimationFrame(timer); step = 0;
    [...seqDiv.children].forEach(p => p.classList.remove('playing'));
    document.getElementById('playBtn').textContent='Play';
});

document.getElementById('reverseBtn').addEventListener('click', (e) => {
    isReversed = !isReversed; e.target.classList.toggle('active', isReversed);
});

const stutterBtn = document.getElementById('stutterBtn');
stutterBtn.addEventListener('mousedown', () => {
    if (!isPlaying) return;
    isStuttering = true;
    stutterStartStep = (step -1) % 16;
    stutterBtn.classList.add('active');
});
stutterBtn.addEventListener('mouseup', () => {
    isStuttering = false;
    stutterBtn.classList.remove('active');
});
stutterBtn.addEventListener('mouseleave', () => {
    isStuttering = false;
    stutterBtn.classList.remove('active');
});


/* ---------- Event Listeners for Controls ---------- */
uiKnobs.swing.addEventListener('input', e => swing = +e.target.value);
uiKnobs.gvol.addEventListener('input', e => masterGain.gain.value = +e.target.value / 100);
uiKnobs.drive.addEventListener('input', e => setDrive(+e.target.value / 100));
uiKnobs.comp.addEventListener('input', e => setComp(+e.target.value / 100));
uiKnobs.stutterRate.addEventListener('input', e => stutterRate = +e.target.value);

Object.keys(uiKnobs).forEach(key => {
    if (['swing', 'gvol', 'drive', 'comp', 'stutterRate'].includes(key)) return;
    uiKnobs[key].addEventListener('input', e => {
        updateParamFromUI(key, e.target.type === 'range' ? +e.target.value : e.target.value);
    });
});

document.querySelectorAll('.oscTab').forEach(tab => {
    tab.addEventListener('click', () => {
        document.querySelector('.oscTab.active').classList.remove('active');
        tab.classList.add('active');
        applyParamsToUI();
    });
});
document.querySelectorAll('#waveSel button').forEach(b => {
    b.addEventListener('click', () => {
        const currentOsc = document.querySelector('.oscTab.active').dataset.osc;
        tracks[currentTrack].params.osc[currentOsc].wave = b.dataset.wave;
        applyParamsToUI();
    });
});
document.querySelectorAll('#muteGroupSel button').forEach(b => {
    b.addEventListener('click', () => {
        tracks[currentTrack].params.muteGroup = +b.dataset.group;
        applyParamsToUI();
    });
});

function loadSoundPreset(direction) {
    currentPresetIndex = (currentPresetIndex + direction + soundPresets.length) % soundPresets.length;
    const newPreset = soundPresets[currentPresetIndex];
    const oldSteps = tracks[currentTrack].params.steps;
    const oldMuted = tracks[currentTrack].params.muted;
    const oldMuteGroup = tracks[currentTrack].params.muteGroup;
    tracks[currentTrack].params = { ...defaultParams(), ...newPreset, steps: oldSteps, muted: oldMuted, muteGroup: oldMuteGroup };
    applyParamsToUI();
    renderTracks();
}

document.getElementById('nextPreset').addEventListener('click', () => loadSoundPreset(1));
document.getElementById('prevPreset').addEventListener('click', () => loadSoundPreset(-1));

document.getElementById('resetBtn').addEventListener('click', () => {
    const originalParams = initialKit[currentTrack];
    const oldSteps = tracks[currentTrack].params.steps;
    const oldMuted = tracks[currentTrack].params.muted;
    tracks[currentTrack].params = { ...JSON.parse(JSON.stringify(originalParams)), steps: oldSteps, muted: oldMuted };
    applyParamsToUI();
    renderTracks();
});

document.getElementById('audition').addEventListener('click', () => {
    ctx.resume(); triggerVoice(tracks[currentTrack], currentTrack);
});

// Initial Load
initTracksWithKit();
renderSeq();

</script>
</body>
</html>
