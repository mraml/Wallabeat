<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Wombat — Tempest‑Inspired Drum Synth</title>
<style>
  :root{
    --bg:#0f1722;--panel:#121b28;--panel2:#162235;--muted:#7c91b1;
    --fg:#d9e2f2;--accent:#19b6ff;--accent2:#00d2a8;--warning:#ff7a7a;
    --shadow:0 10px 24px rgba(0,0,0,.35);
  }
  *{box-sizing:border-box;font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
  html,body{margin:0;background:radial-gradient(1200px 600px at 70% -200px,#162235 0%,#0f1722 60%);color:var(--fg)}
  .wrap{max-width:1200px;margin:24px auto 80px;padding:0 16px}
  header{
    display:flex;align-items:center;gap:16px;margin-bottom:16px; flex-wrap: wrap;
  }
  .brand{font-weight:900;font-size:34px;letter-spacing:.2px;color:#40c9ff;text-shadow:0 2px 0 rgba(0,0,0,.35)}
  .sp{flex:1}
  .chip{display:inline-flex;align-items:center;gap:10px;background:var(--panel2);padding:8px 12px;border-radius:14px;box-shadow:var(--shadow)}
  .chip small{opacity:.75}
  .knobrow{display:flex;gap:14px;align-items:center;flex-wrap:wrap}
  .btn{
    background:#1f2b40;border:0;color:var(--fg);padding:12px 22px;border-radius:999px;
    font-weight:700;box-shadow:var(--shadow);cursor:pointer;transition:.15s transform,.15s background; user-select: none;
  }
  .btn:active{transform:translateY(1px)}
  .btn.play{background:linear-gradient(180deg,#26d2ff,#1485ff)}
  .btn.stop{background:linear-gradient(180deg,#ff9a9a,#ff5d5d)}
  .btn.reverse.active{background:var(--accent2); color: var(--bg);}
  .btn.fx-rec.active, .btn.mute-btn.muted, .btn.flam-btn.active, .btn.fx-bypass.active{background:var(--warning); color: var(--bg);}
  .panel{
    background:linear-gradient(180deg,#121b28,#0f1722);border-radius:18px;padding:16px;box-shadow:var(--shadow);margin:9px 0
  }
  .block{
    background:var(--panel2);border-radius:14px;padding:12px;
    display: flex; flex-direction: column; justify-content: space-between;
  }
  .block .label{font-size:12px;color:var(--muted);margin-top:8px;text-align:center}
  .row{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
  .preset{display:flex;align-items:center;gap:8px}
  .preset .presetname{background:#0e1522;border:1px solid #1f2b40;color:#bfe4ff;border-radius:10px;padding:8px 16px;min-width:140px;text-align:center}
  .preset .mini{width:36px;height:36px;border-radius:10px;background:#1f2b40;color:#cde8ff;border:0;font-weight:900;cursor:pointer}
  .preset .tri{width:42px;height:42px;border-radius:12px;background:#19b6ff;color:#001a2a;border:0;font-weight:900;cursor:pointer}
  
  .osc-toggle-wrap { display: flex; flex-direction: column; align-items: center; gap: 4px; }
  .osc-toggle { display: flex; align-items: center; gap: 6px; background: #1a2538; padding: 4px; border-radius: 8px; }
  .osc-dot { width: 10px; height: 10px; border-radius: 50%; background: #2f4671; transition: .15s background; }
  .osc-dot.active { background: var(--accent); }
  #oscToggleButton { font-size: 10px; padding: 4px 8px; border-radius: 6px; }

  /* Sequencer */
  .seq{display:grid;grid-template-columns:repeat(8,1fr);gap:12px;margin-top:10px}
  .pad{aspect-ratio:1/1;background:linear-gradient(180deg,#26344c,#1a2540);
       border-radius:14px;display:flex;align-items:flex-end;justify-content:flex-end;padding:6px;position:relative;
       box-shadow: inset 0 2px 8px rgba(0,0,0,.45), var(--shadow);cursor:pointer;user-select:none}
  .pad.on{background:linear-gradient(180deg, var(--accent), #1485ff)}
  .pad.playing{outline:3px solid var(--accent)}
  .pad small{position:absolute;bottom:6px;left:8px;color:#b9c7e3;opacity:.8; font-size: 12px;}
  /* Knobs (rotary range) */
  .knob{
    --size:60px; --track:#26405f; --tick:#7fbaff;
    width:var(--size);height:var(--size);border-radius:50%;
    background:conic-gradient(from -135deg, var(--tick) 0deg 0deg, #1b2a44 0deg 360deg), radial-gradient(circle at 50% 45%, #233653 0 60%, #0e192a 60% 100%);
    position:relative;display:grid;place-items:center;box-shadow:inset 0 4px 9px rgba(0,0,0,.6),0 6px 14px rgba(0,0,0,.35)
  }
  .knob input{position:absolute;inset:0;opacity:0;cursor:pointer}
  .knob .dot{
    width:6px;height:6px;border-radius:50%;background:#bfe4ff;
    transform-origin: center;
    transform: rotate(0deg) translateY(calc(-1 * var(--size) / 3.0));
  }
  .kwrap{display:flex;flex-direction:column;align-items:center;gap:6px;width:86px}
  .kwrap .tag{font-size:12px;color:#a5b8d9;text-align:center}
  .miniSel{display:flex;gap:6px; align-items: center;}
  .miniSel button{background:#21304b;border:0;color:#cde4ff;border-radius:12px;padding:6px 8px;cursor:pointer}
  .miniSel button.sel{background:#2f4671}
  .help{opacity:.7;font-size:12px}
  .param-section { display: flex; gap: 16px; margin-top: 16px; flex-wrap: wrap;}
  .page-indicators{display:flex; gap: 8px; align-items: center;}
  .page-dot{width: 12px; height: 12px; border-radius: 50%; background: #1f2b40; transition: .15s background;}
  .page-dot.has-steps{background: #2f4671;}
  .page-dot.active{background: var(--accent);}
  .page-dot.playing{background: var(--accent2);}
</style>
</head>
<body>
<div class="wrap">
  <header>
  </header>

  <section class="panel">
    <div class="block" style="display:flex; flex-direction: row; align-items:center;justify-content:flex-start;gap:16px; flex-wrap: wrap;">
      <div class="row">
        <div class="preset">
            <button id="prevTrack" class="mini">&lt;</button>
            <div id="trackName" class="presetname" style="min-width: 120px;"></div>
            <button id="nextTrack" class="mini">&gt;</button>
        </div>
        <div class="preset">
            <span class="help">Voice</span>
            <button id="prevPreset" class="mini">&lt;</button>
            <div id="presetName" class="presetname"></div>
            <button id="nextPreset" class="mini">&gt;</button>
            <button id="audition" class="tri">▶</button>
            <button id="resetBtn" class="btn" style="padding: 8px 16px;">Reset</button>
        </div>
      </div>
       <div class="miniSel">
            <span class="help">Mute Group</span>
            <div id="muteGroupSel">
                <button data-group="0" class="sel">None</button>
                <button data-group="1">1</button>
                <button data-group="2">2</button>
            </div>
       </div>
    </div>

    <div class="param-section">
        <!-- OSCILLATORS -->
        <div class="block" style="flex: 1.5;">
            <div>
                <div class="row" style="gap:18px; justify-content: center;">
                    <div class="osc-toggle-wrap">
                        <div class="osc-toggle">
                            <span id="osc1Dot" class="osc-dot active"></span>
                            <button id="oscToggleButton" class="btn mini">1/2</button>
                            <span id="osc2Dot" class="osc-dot"></span>
                        </div>
                        <small class="help">OSC</small>
                    </div>
                    <div class="preset" id="waveSel">
                        <div class="presetname" id="waveName" style="min-width: 90px;">Sine</div>
                        <button id="nextWave" class="mini">&gt;</button>
                    </div>
                    <div class="knobrow">
                        <div class="kwrap"><div class="knob" data-id="pitch1"><span class="dot"></span><input type="range" min="-24" max="24" value="0"></div><div class="tag">Pitch</div></div>
                        <div class="kwrap"><div class="knob" data-id="detune1"><span class="dot"></span><input type="range" min="-50" max="50" value="0"></div><div class="tag">Detune</div></div>
                        <div class="kwrap"><div class="knob" data-id="blend"><span class="dot"></span><input type="range" min="0" max="100" value="70"></div><div class="tag">Blend</div></div>
                    </div>
                </div>
            </div>
            <div class="label">Oscillators</div>
        </div>
        <!-- FILTER & ENV -->
        <div class="block" style="flex: 2;">
            <div>
                <div class="knobrow" style="justify-content: center;">
                    <div class="kwrap"><div class="knob" data-id="a"><span class="dot"></span><input type="range" min="0" max="1000" value="2"></div><div class="tag">Attack</div></div>
                    <div class="kwrap"><div class="knob" data-id="d"><span class="dot"></span><input type="range" min="1" max="2000" value="80"></div><div class="tag">Decay</div></div>
                    <div class="kwrap"><div class="knob" data-id="s"><span class="dot"></span><input type="range" min="0" max="1" step="0.01" value="0.0"></div><div class="tag">Sustain</div></div>
                    <div class="kwrap"><div class="knob" data-id="r"><span class="dot"></span><input type="range" min="1" max="2000" value="120"></div><div class="tag">Release</div></div>
                </div>
                <div class="knobrow" style="justify-content: center; margin-top: 16px;">
                    <div class="kwrap"><div class="knob" data-id="h"><span class="dot"></span><input type="range" min="0" max="1000" value="0"></div><div class="tag">Hold</div></div>
                    <div class="kwrap"><div class="knob" data-id="fdecay"><span class="dot"></span><input type="range" min="1" max="2000" value="200"></div><div class="tag">F.Decay</div></div>
                    <div class="kwrap"><div class="knob" data-id="lp"><span class="dot"></span><input type="range" min="50" max="20000" value="12000" step="1"></div><div class="tag">LP Cut</div></div>
                    <div class="kwrap"><div class="knob" data-id="hp"><span class="dot"></span><input type="range" min="20" max="2000" value="30" step="1"></div><div class="tag">HP Cut</div></div>
                </div>
            </div>
            <div class="label">Filter & Envelope</div>
        </div>
        <!-- MASTER CONTROLS -->
        <div class="block" style="flex: 1.8;">
            <div>
                <div class="knobrow" style="justify-content: center;">
                    <div class="kwrap"><div class="knob" data-id="velocity"><span class="dot"></span><input type="range" min="1" max="127" value="100"></div><div class="tag">Velocity</div></div>
                    <div class="kwrap"><div class="knob" data-id="pan"><span class="dot"></span><input type="range" min="-1" max="1" step="0.01" value="0"></div><div class="tag">Pan</div></div>
                    <div class="kwrap"><div class="knob" data-id="reverbSend"><span class="dot"></span><input type="range" min="0" max="1" step="0.01" value="0"></div><div class="tag">Reverb</div></div>
                </div>
                <div class="knobrow" style="justify-content: center; margin-top: 16px;">
                    <div class="kwrap"><div class="knob" data-id="delaySend"><span class="dot"></span><input type="range" min="0" max="1" step="0.01" value="0"></div><div class="tag">Delay</div></div>
                    <div class="kwrap"><div class="knob" data-id="delayTime"><span class="dot"></span><input type="range" min="0.01" max="1" step="0.01" value="0.25"></div><div class="tag">Dly Time</div></div>
                    <div class="kwrap"><div class="knob" data-id="delayFb"><span class="dot"></span><input type="range" min="0" max="0.9" step="0.01" value="0.3"></div><div class="tag">Dly FB</div></div>
                </div>
            </div>
             <div class="label">Mix & Effects</div>
        </div>
    </div>
    <div class="param-section">
        <!-- MODULATION -->
        <div class="block" style="flex: 1;">
            <div>
                <div class="row knobrow" style="justify-content: center;">
                    <div class="kwrap"><div class="knob" data-id="lfoRate"><span class="dot"></span><input type="range" min="0.1" max="30" step="0.1" value="5"></div><div class="tag">LFO Rate</div></div>
                    <div class="kwrap"><div class="knob" data-id="lfoDepth"><span class="dot"></span><input type="range" min="0" max="100" value="0"></div><div class="tag">LFO Depth</div></div>
                    <div class="miniSel" id="lfoTargetSel">
                        <button data-target="pitch" class="sel">Pitch</button>
                        <button data-target="filter">Filter</button>
                        <button data-target="pan">Pan</button>
                        <button data-target="blend">Blend</button>
                    </div>
                </div>
            </div>
            <div class="label">Modulation</div>
        </div>
        <!-- PERFORMANCE -->
        <div class="block" style="flex: 1;">
            <div>
                <div class="row knobrow" style="justify-content: center;">
                    <div class="kwrap">
                        <div class="knob" data-id="rollRate"><span class="dot"></span><input type="range" min="0" max="3" value="1" step="1"></div>
                        <div class="tag" id="rollRateTag">Rate</div>
                        <button id="rollBtn" class="btn" style="height: 42px; width: 60px; border-radius: 12px; padding: 0; margin-top: 8px;">Roll</button>
                    </div>
                    <div style="display: flex; flex-direction: column; gap: 8px;">
                        <button id="flamBtn" class="btn flam-btn" style="height: 42px; width: 60px; border-radius: 12px; padding: 0;">Flam</button>
                        <button id="reverseBtn" class="btn reverse" style="height: 42px; width: 60px; border-radius: 12px; padding: 0;">Reverse</button>
                        <button id="fxBypassBtn" class="btn fx-bypass" style="height: 42px; width: 60px; border-radius: 12px; padding: 0;">FX Bypass</button>
                    </div>
                     <div style="display: flex; flex-direction: column; gap: 8px;">
                         <button id="muteBtn" class="btn mute-btn" style="height: 42px; width: 60px; border-radius: 12px; padding: 0;">Mute</button>
                    </div>
                </div>
            </div>
            <div class="label">Performance</div>
        </div>
        <!-- MASTER & TRANSPORT -->
        <div class="block" style="flex: 1.8;">
            <div>
                <div class="knobrow" style="justify-content: center;">
                    <div class="kwrap"><div class="knob" data-id="swing"><span class="dot"></span><input type="range" min="0" max="100" value="0"></div><div class="tag">Swing</div></div>
                    <div class="kwrap"><div class="knob" data-id="drive"><span class="dot"></span><input type="range" min="0" max="100" value="10"></div><div class="tag">Drive</div></div>
                    <div class="kwrap"><div class="knob" data-id="tape"><span class="dot"></span><input type="range" min="0" max="100" value="0"></div><div class="tag">Tape/Vinyl</div></div>
                </div>
                <div class="knobrow" style="justify-content: center; margin-top: 16px;">
                    <div class="kwrap"><div class="knob" data-id="masterHP"><span class="dot"></span><input type="range" min="20" max="10000" value="20"></div><div class="tag">Master HPF</div></div>
                    <div class="kwrap"><div class="knob" data-id="masterLP"><span class="dot"></span><input type="range" min="100" max="20000" value="20000"></div><div class="tag">Master LPF</div></div>
                    <div class="kwrap"><div class="knob" data-id="gvol"><span class="dot"></span><input type="range" min="0" max="100" value="80"></div><div class="tag">Master Vol</div></div>
                </div>
                 <div class="row" style="justify-content: center; margin-top: 16px; gap: 16px;">
                    <div class="chip"><small>BPM</small>
                    <input id="bpm" type="number" min="40" max="240" step="1" value="120"
                            style="width:74px;background:#0e1522;border:1px solid #1f2b40;color:#dff0ff;border-radius:10px;padding:8px 10px"/>
                    </div>
                    <button id="fxRecBtn" class="btn fx-rec" style="padding: 8px 16px; border-radius: 12px;">FX REC</button>
                    <button id="playBtn" class="btn play" style="padding: 8px 16px; border-radius: 12px;">Play</button>
                    <button id="stopBtn" class="btn stop" style="padding: 8px 16px; border-radius: 12px;">Stop</button>
                </div>
            </div>
             <div class="label">Master & Transport</div>
        </div>
    </div>
  </section>

  <section class="panel">
    <div class="row" style="align-items: center; margin-bottom: 16px;">
        <div class="brand">Wombat</div>
        <div class="sp"></div>
        <div id="pageIndicators" class="page-indicators"></div>
        <div class="preset" style="margin-left: 16px;">
            <span class="help">Page</span>
            <button id="prevPageBtn" class="mini">&lt;</button>
            <div id="pageNum" class="presetname" style="min-width: 40px;">1</div>
            <button id="nextPageBtn" class="mini">&gt;</button>
        </div>
    </div>
    <div id="seq" class="seq"></div>
  </section>

</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    /* ---------- Utilities: rotary visuals ---------- */
    function initKnobs() {
        document.querySelectorAll('.knob').forEach(k=>{
        const input=k.querySelector('input');
        const dot=k.querySelector('.dot');
        const update=()=>{
            const min=+input.min, max=+input.max, val=+input.value;
            const pct=(val-min)/(max-min);
            const deg = -135 + pct * 270; // Corrected range for 7 o'clock to 5 o'clock
            dot.style.transform=`rotate(${deg}deg) translateY(calc(-1 * var(--size) / 3.0))`;
        };
        input.addEventListener('input',update);
        input.dispatchEvent(new Event('input'));
        });
    }
    initKnobs();

    /* ---------- Audio Engine ---------- */
    const AudioCtx=window.AudioContext||window.webkitAudioContext;
    const ctx=new AudioCtx();
    let masterGain=ctx.createGain(); masterGain.gain.value=0.8;
    let driveNode=ctx.createWaveShaper();
    let tapeWobble = ctx.createOscillator();
    let tapeWobbleGain = ctx.createGain();
    tapeWobble.frequency.value = 0.5;
    tapeWobble.connect(tapeWobbleGain);
    tapeWobble.start();
    let masterHP = ctx.createBiquadFilter(); masterHP.type = 'highpass'; masterHP.frequency.value = 20;
    let masterLP = ctx.createBiquadFilter(); masterLP.type = 'lowpass'; masterLP.frequency.value = 20000;
    let comp=ctx.createDynamicsCompressor();
    let activeVoices = [null, null, null];

    masterGain.connect(driveNode).connect(masterHP).connect(masterLP).connect(comp).connect(ctx.destination);

    function setDrive(amount){
        const k=amount*2+1; const n=44100; const curve=new Float32Array(n);
        for(let i=0;i<n;i++){ const x=i*2/n-1; curve[i]=Math.tanh(k*x); }
        driveNode.curve=curve;
    }
    function setTape(amount) {
        const intensity = amount / 100;
        tapeWobbleGain.gain.value = intensity * 2; // Pitch wobble
        const hpFreq = 20 + intensity * 200;
        const lpFreq = 20000 - intensity * 10000;
        masterHP.frequency.setTargetAtTime(hpFreq, ctx.currentTime, 0.01);
        masterLP.frequency.setTargetAtTime(lpFreq, ctx.currentTime, 0.01);
    }
    function setComp(amount) {
        comp.threshold.value = -50 + (1-amount) * 50;
        comp.ratio.value = 1 + amount * 19;
    }

    function makeImpulse(len=2,decay=0.4){
    const rate=ctx.sampleRate; const length=rate*len; const ir=ctx.createBuffer(2,length,rate);
    for(let ch=0; ch<2; ch++){
        const data=ir.getChannelData(ch);
        for(let i=0;i<length;i++){data[i]=(Math.random()*2-1)*Math.pow(1-i/length, decay);}
    } return ir;
    }
    const impulseBuffer = makeImpulse(2.2, 0.5);

    const trackFX = [...Array(8)].map(() => {
        const reverb = ctx.createConvolver(); reverb.buffer = impulseBuffer;
        const reverbSend = ctx.createGain(); reverbSend.gain.value = 0;
        reverbSend.connect(reverb).connect(masterGain);

        const delay = ctx.createDelay(1.0); const delayFb = ctx.createGain();
        const delaySend = ctx.createGain(); delaySend.gain.value = 0;
        delaySend.connect(delay); delay.connect(delayFb).connect(delay);
        delay.connect(masterGain);
        return { reverbSend, delay, delayFb, delaySend };
    });

    let isFxBypassed = false;
    function triggerVoice(track, trackIndex, when=ctx.currentTime, velocityOverride = null){
    const p=track.params;
    const velocity = (velocityOverride || p.steps[step % 128] || p.velocity) / 127;
    const vGain=ctx.createGain();

    const mg = p.muteGroup;
    if (mg > 0) {
        if (activeVoices[mg]) {
            activeVoices[mg].gain.cancelScheduledValues(when);
            activeVoices[mg].gain.setValueAtTime(activeVoices[mg].gain.value, when);
            activeVoices[mg].gain.linearRampToValueAtTime(0, when + 0.01);
        }
        activeVoices[mg] = vGain;
    }

    const panner=ctx.createStereoPanner(); panner.pan.value=p.pan;
    const hp=ctx.createBiquadFilter(); hp.type='highpass'; hp.frequency.value=p.hp; hp.Q.value=0.7;
    const lp=ctx.createBiquadFilter(); lp.type='lowpass'; lp.frequency.value=p.lp; lp.Q.value=p.res;
    
    const sources=[];
    const oscGains = [];
    for(let i=0;i<2;i++){
        const oscCfg=p.osc[i];
        let src;
        if(oscCfg.wave==='noise'){
        const b=ctx.createBuffer(1, ctx.sampleRate*2, ctx.sampleRate);
        const data=b.getChannelData(0); for(let k=0;k<data.length;k++) data[k]=Math.random()*2-1;
        src=ctx.createBufferSource(); src.buffer=b; src.loop=true;
        }else{
        src=ctx.createOscillator(); src.type=oscCfg.wave;
        const base= 55 * Math.pow(2,(p.pitch1)/12);
        src.frequency.setValueAtTime(base, when);
        src.detune.setValueAtTime((i===0 ? p.detune1 : -p.detune1), when);
        tapeWobbleGain.connect(src.detune);
        }
        const g=ctx.createGain();
        g.gain.value = (i===0 ? (p.blend/100) : (1-p.blend/100));
        src.connect(g);
        sources.push(src);
        oscGains.push(g);
    }
    const mix = ctx.createGain();
    oscGains[0].connect(mix);
    oscGains[1].connect(mix);

    const lfo = ctx.createOscillator(); lfo.frequency.value = p.lfoRate;
    const lfoGain = ctx.createGain();
    lfo.connect(lfoGain);
    lfo.start(when);
    
    switch(p.lfoTarget) {
        case 'pitch': lfoGain.gain.value = p.lfoDepth * 24; sources.forEach(s => { if(s.frequency) lfoGain.connect(s.frequency); }); break;
        case 'filter': lfoGain.gain.value = p.lfoDepth * 5000; lfoGain.connect(lp.frequency); break;
        case 'pan': lfoGain.gain.value = p.lfoDepth; lfoGain.connect(panner.pan); break;
        case 'blend':
            lfoGain.gain.value = p.lfoDepth / 100;
            const blendInverter = ctx.createGain(); blendInverter.gain.value = -1;
            lfoGain.connect(oscGains[0].gain);
            lfoGain.connect(blendInverter).connect(oscGains[1].gain);
            break;
    }

    const now=when;
    const a=p.a/1000, h=p.h/1000, d=p.d/1000, s=p.s, r=p.r/1000;
    vGain.gain.cancelScheduledValues(now);
    vGain.gain.setValueAtTime(0, now);
    vGain.gain.linearRampToValueAtTime(velocity, now+a);
    vGain.gain.setValueAtTime(velocity, now+a+h);
    vGain.gain.linearRampToValueAtTime(s * velocity, now+a+h+d);
    vGain.gain.linearRampToValueAtTime(0, now+a+h+d+r);

    mix.connect(hp).connect(lp).connect(vGain).connect(panner).connect(masterGain);
    if (!isFxBypassed) {
        const fx = trackFX[trackIndex];
        panner.connect(fx.reverbSend);
        panner.connect(fx.delaySend);
    }

    const stopAt=now+a+h+d+r+0.1;
    sources.forEach(s=>{if(s.start) s.start(now); s.stop(stopAt);});
    lfo.stop(stopAt);
    
    if (mg > 0) {
        setTimeout(() => { if (activeVoices[mg] === vGain) activeVoices[mg] = null; }, (stopAt - ctx.currentTime) * 1000);
    }
    }

    /* ---------- Model & Presets ---------- */
    const defaultParams=()=>({
    osc:[{wave:'sine'},{wave:'square'}], pitch1:0, detune1:0, blend:70,
    lp:12000, hp:30, res:0.7, a:2, h:0, d:80,s:0,r:120, fdecay: 200, pan:0,
    lfoRate: 5, lfoDepth: 0, lfoTarget: 'pitch', velocity: 100,
    reverbSend: 0, delaySend: 0, delayTime: 0.25, delayFb: 0.3,
    muted:false, steps:Array(128).fill(0), name:'New Sound', muteGroup: 0, flam: false
    });

    const soundPresets = [
        { name: 'Kick 808', pitch1: -12, d: 250, r: 250, lp: 400, blend: 100, osc: [{wave: 'sine'}, {wave: 'sine'}] },
        { name: 'Kick 909', pitch1: -10, d: 180, r: 180, lp: 800, blend: 80, osc: [{wave: 'triangle'}, {wave: 'noise'}] },
        { name: 'Kick Hard', pitch1: -14, d: 150, r: 150, lp: 1200, blend: 100, osc: [{wave: 'square'}, {wave: 'sawtooth'}] },
        { name: 'Snare 808', blend: 20, d: 120, r: 120, hp: 200, lp: 8000, osc: [{wave: 'noise'}, {wave: 'triangle'}] },
        { name: 'Snare Tight', blend: 30, d: 80, r: 80, hp: 300, lp: 9000, osc: [{wave: 'noise'}, {wave: 'sine'}] },
        { name: 'Snare LoFi', blend: 10, d: 150, r: 150, hp: 100, lp: 5000, osc: [{wave: 'noise'}, {wave: 'square'}] },
        { name: 'Hat Closed', pitch1: 12, d: 50, r: 50, hp: 6000, osc: [{wave: 'noise'}, {wave: 'noise'}], muteGroup: 1 },
        { name: 'Hat Open', pitch1: 12, d: 400, r: 400, hp: 5000, osc: [{wave: 'noise'}, {wave: 'square'}], muteGroup: 1 },
        { name: 'Hat Crispy', pitch1: 14, d: 60, r: 60, hp: 8000, osc: [{wave: 'noise'}, {wave: 'sawtooth'}], muteGroup: 1 },
        { name: 'Tom Lo', pitch1: -5, d: 250, r: 250, lp: 1500, osc: [{wave: 'triangle'}, {wave: 'sine'}] },
        { name: 'Tom Mid', pitch1: 0, d: 200, r: 200, lp: 2000, osc: [{wave: 'triangle'}, {wave: 'sine'}] },
        { name: 'Tom Hi', pitch1: 5, d: 150, r: 150, lp: 2500, osc: [{wave: 'triangle'}, {wave: 'sine'}] },
        { name: 'Crash', pitch1: 16, d: 1200, r: 1200, hp: 4000, lp: 15000, osc: [{wave: 'noise'}, {wave: 'square'}], blend: 70 },
        { name: 'Ride', pitch1: 14, d: 800, r: 800, hp: 3000, lp: 18000, osc: [{wave: 'square'}, {wave: 'noise'}], blend: 40 },
        { name: 'China', pitch1: 18, d: 1000, r: 1000, hp: 2000, lp: 16000, osc: [{wave: 'sawtooth'}, {wave: 'noise'}], blend: 60 },
        { name: 'Clap', blend: 50, d: 90, r: 90, hp: 1000, lp: 9000, osc: [{wave: 'noise'}, {wave: 'noise'}] },
        { name: 'Rimshot', pitch1: 12, d: 60, r: 60, lp: 4000, hp: 1000, osc: [{wave: 'square'}, {wave: 'square'}] },
        { name: 'Cowbell', pitch1: 7, detune1: 25, d: 150, r: 150, lp: 10000, osc: [{wave: 'square'}, {wave: 'square'}], blend: 50 },
        { name: 'Zap', pitch1: -12, d: 200, r: 200, lp: 2000, res: 15, osc: [{wave: 'sawtooth'}, {wave: 'sawtooth'}] },
        { name: 'Blip', pitch1: 12, d: 30, r: 30, lp: 3000, res: 5, osc: [{wave: 'triangle'}, {wave: 'triangle'}] },
        { name: 'Laser', pitch1: 24, d: 300, r: 300, lp: 10000, res: 2, osc: [{wave: 'sawtooth'}, {wave: 'sine'}] }
    ];

    const waveTypes = ['sine', 'square', 'triangle', 'sawtooth', 'noise'];
    let currentPresetIndex = 0;
    let tracks = [];
    let initialKit = [];
    let motionData = { hp: [], lp: [] };
    let currentSeqPage = 0;
    let activeBars = 1;
    let currentOsc = 0;

    function initTracksWithKit() {
        const defaultKitSetup = [
            soundPresets[0], soundPresets[3], soundPresets[6], soundPresets[7],
            soundPresets[9], soundPresets[10], soundPresets[11], soundPresets[12]
        ];
        initialKit = defaultKitSetup.map(p => ({ ...defaultParams(), ...p }));
        tracks = initialKit.map(p => ({ params: JSON.parse(JSON.stringify(p)) }));
        currentTrack = 0;
        applyParamsToUI();
        updateTrackDisplay();
        highlightSteps();
        updateActiveBarsAndIndicators();
    }

    /* ---------- UI Management ---------- */
    const trackNameDiv = document.getElementById('trackName');
    const seqDiv=document.getElementById('seq');
    const pageNumDiv = document.getElementById('pageNum');
    const pageIndicatorsDiv = document.getElementById('pageIndicators');
    const uiKnobs = {};
    document.querySelectorAll('.knob').forEach(k => { uiKnobs[k.dataset.id] = k.querySelector('input'); });

    function applyParamsToUI() {
        if (!tracks.length) return;
        const p = tracks[currentTrack].params;
        for (const key in p) {
            if (uiKnobs[key]) {
                uiKnobs[key].value = p[key];
                uiKnobs[key].dispatchEvent(new Event('input'));
            }
        }
        document.getElementById('waveName').textContent = p.osc[currentOsc].wave;
        document.querySelectorAll('#muteGroupSel button').forEach(b => {
            b.classList.toggle('sel', +b.dataset.group === p.muteGroup);
        });
        document.querySelectorAll('#lfoTargetSel button').forEach(b => {
            b.classList.toggle('sel', b.dataset.target === p.lfoTarget);
        });
        document.getElementById('presetName').textContent = p.name;
        document.getElementById('flamBtn').classList.toggle('active', p.flam);
        document.getElementById('osc1Dot').classList.toggle('active', currentOsc === 0);
        document.getElementById('osc2Dot').classList.toggle('active', currentOsc === 1);
        updateTrackDisplay();
    }

    function updateParamFromUI(param, value) {
        const p = tracks[currentTrack].params;
        p[param] = value;
        const fx = trackFX[currentTrack];
        if (param === 'reverbSend') fx.reverbSend.gain.value = value;
        if (param === 'delaySend') fx.delaySend.gain.value = value;
        if (param === 'delayTime') fx.delay.delayTime.value = value;
        if (param === 'delayFb') fx.delayFb.gain.value = value;
    }

    function updateTrackDisplay(){
        if (!tracks.length) return;
        const p = tracks[currentTrack].params;
        trackNameDiv.textContent = `Track ${currentTrack + 1}: ${p.name}`;
        document.getElementById('muteBtn').classList.toggle('muted', p.muted);
    }

    function renderSeq(){
    seqDiv.innerHTML='';
    for(let i=0;i<16;i++){
        const pad=document.createElement('div'); pad.className='pad';
        pad.innerHTML=`<small>${i+1}</small>`;
        pad.addEventListener('click',()=>{
        const stepIndex = currentSeqPage * 16 + i;
        const st=tracks[currentTrack].params.steps;
        const vel = tracks[currentTrack].params.velocity;
        st[stepIndex] = st[stepIndex] > 0 ? 0 : vel;
        highlightSteps();
        updateActiveBarsAndIndicators();
        });
        seqDiv.appendChild(pad);
    }
    highlightSteps();
    }

    function highlightSteps(){
        if (!tracks.length) return;
        const st=tracks[currentTrack].params.steps;
        const pageOffset = currentSeqPage * 16;
        [...seqDiv.children].forEach((p,i)=>{
            const vel = st[pageOffset + i];
            p.classList.toggle('on', vel > 0);
            p.style.opacity = vel > 0 ? (vel / 127) * 0.7 + 0.3 : 1;
        });
    }

    function updateActiveBarsAndIndicators() {
        let lastStep = -1;
        tracks.forEach(t => {
            for (let i = 127; i >= 0; i--) {
                if (t.params.steps[i] > 0) {
                    lastStep = Math.max(lastStep, i);
                    break;
                }
            }
        });
        activeBars = lastStep < 0 ? 1 : Math.floor(lastStep / 16) + 1;
        
        pageIndicatorsDiv.innerHTML = '';
        for (let i = 0; i < 8; i++) {
            const dot = document.createElement('div');
            dot.className = 'page-dot';
            dot.classList.toggle('active', i === currentSeqPage);
            let pageHasSteps = false;
            for (const t of tracks) {
                if (t.params.steps.slice(i * 16, (i + 1) * 16).some(s => s > 0)) {
                    pageHasSteps = true;
                    break;
                }
            }
            dot.classList.toggle('has-steps', pageHasSteps);
            pageIndicatorsDiv.appendChild(dot);
        }
    }


    /* ---------- Transport / clock ---------- */
    let isPlaying=false, isReversed=false, step=0, lastTick=0, swing=0, timer=0;
    let isRolling = false, rollRate = 1;
    const rollRates = [4, 8, 16, 32];
    const rollRateLabels = ["1/8", "1/16", "1/32", "1/64"];
    let isFxRec = false;

    function schedule(){
    const bpm=+document.getElementById('bpm').value;
    const spb=60/bpm; const stepDur=spb/4;
    const swingAmt = (swing / 100) * stepDur * 0.5;
    const now=ctx.currentTime;

    while(lastTick < now + 0.1){
        const absoluteStep = step % (activeBars * 16);
        const seqPos = isReversed ? (activeBars * 16 - 1) - absoluteStep : absoluteStep;

        const timeAt = lastTick + ((step % 2) ? swingAmt : -swingAmt);
        tracks.forEach((t,ti)=>{
            if(!t.params.muted && t.params.steps[seqPos]) {
                if (t.params.flam) {
                    triggerVoice(t, ti, timeAt + stepDur - 0.03, t.params.velocity * 0.5);
                }
                triggerVoice(t, ti, timeAt + stepDur);
            }
        });

        if (motionData.hp[absoluteStep] !== undefined) masterHP.frequency.setTargetAtTime(motionData.hp[absoluteStep], timeAt + stepDur, 0.01);
        if (motionData.lp[absoluteStep] !== undefined) masterLP.frequency.setTargetAtTime(motionData.lp[absoluteStep], timeAt + stepDur, 0.01);

        const currentBar = Math.floor(absoluteStep / 16);
        setTimeout(()=>{
            [...seqDiv.children].forEach(p=>p.classList.remove('playing'));
            if (Math.floor(seqPos / 16) === currentSeqPage) {
                seqDiv.children[seqPos % 16].classList.add('playing');
            }
            [...pageIndicatorsDiv.children].forEach((dot, i) => dot.classList.toggle('playing', i === currentBar));
        }, (timeAt - now + stepDur)*1000);

        lastTick += stepDur;
        step++;
    }
    if(isPlaying) timer=requestAnimationFrame(schedule);
    }

    document.getElementById('playBtn').addEventListener('click',()=>{
    ctx.resume();
    if(!isPlaying){
        isPlaying=true; step=0; lastTick=ctx.currentTime; schedule();
        playBtn.textContent='Pause';
    } else {
        isPlaying = false;
        cancelAnimationFrame(timer);
        playBtn.textContent='Play';
    }
    });

    document.getElementById('stopBtn').addEventListener('click', () => {
        isPlaying = false; cancelAnimationFrame(timer); step = 0;
        [...seqDiv.children].forEach(p => p.classList.remove('playing'));
        [...pageIndicatorsDiv.children].forEach(dot => dot.classList.remove('playing'));
        document.getElementById('playBtn').textContent='Play';
    });

    document.getElementById('reverseBtn').addEventListener('click', (e) => {
        isReversed = !isReversed; e.target.classList.toggle('active', isReversed);
    });

    const rollBtn = document.getElementById('rollBtn');
    rollBtn.addEventListener('mousedown', () => isRolling = true);
    rollBtn.addEventListener('mouseup', () => isRolling = false);
    rollBtn.addEventListener('mouseleave', () => isRolling = false);

    const fxRecBtn = document.getElementById('fxRecBtn');
    fxRecBtn.addEventListener('click', (e) => {
        if (e.shiftKey) {
            motionData = { hp: [], lp: [] };
            return;
        }
        isFxRec = !isFxRec;
        fxRecBtn.classList.toggle('active', isFxRec);
        if (isFxRec) motionData = { hp: [], lp: [] };
    });


    /* ---------- Event Listeners for Controls ---------- */
    uiKnobs.swing.addEventListener('input', e => swing = +e.target.value);
    uiKnobs.gvol.addEventListener('input', e => masterGain.gain.value = +e.target.value / 100);
    uiKnobs.drive.addEventListener('input', e => setDrive(+e.target.value / 100));
    uiKnobs.tape.addEventListener('input', e => setTape(+e.target.value));
    uiKnobs.masterHP.addEventListener('input', e => {
        masterHP.frequency.setTargetAtTime(+e.target.value, ctx.currentTime, 0.01);
        if (isFxRec && isPlaying) motionData.hp[step % 128] = +e.target.value;
    });
    uiKnobs.masterLP.addEventListener('input', e => {
        masterLP.frequency.setTargetAtTime(+e.target.value, ctx.currentTime, 0.01);
        if (isFxRec && isPlaying) motionData.lp[step % 128] = +e.target.value;
    });
    uiKnobs.rollRate.addEventListener('input', e => {
        rollRate = +e.target.value;
        document.getElementById('rollRateTag').textContent = rollRateLabels[rollRate];
    });


    Object.keys(uiKnobs).forEach(key => {
        if (['swing', 'gvol', 'drive', 'tape', 'masterHP', 'masterLP', 'rollRate'].includes(key)) return;
        uiKnobs[key].addEventListener('input', e => {
            updateParamFromUI(key, e.target.type === 'range' ? +e.target.value : e.target.value);
        });
    });

    document.getElementById('oscToggleButton').addEventListener('click', () => {
        currentOsc = 1 - currentOsc; // Toggle between 0 and 1
        applyParamsToUI();
    });
    document.getElementById('nextWave').addEventListener('click', () => {
        const p = tracks[currentTrack].params;
        const currentWave = p.osc[currentOsc].wave;
        const currentIndex = waveTypes.indexOf(currentWave);
        const nextIndex = (currentIndex + 1) % waveTypes.length;
        p.osc[currentOsc].wave = waveTypes[nextIndex];
        applyParamsToUI();
    });
    document.querySelectorAll('#muteGroupSel button').forEach(b => {
        b.addEventListener('click', () => {
            tracks[currentTrack].params.muteGroup = +b.dataset.group;
            applyParamsToUI();
        });
    });
    document.querySelectorAll('#lfoTargetSel button').forEach(b => {
        b.addEventListener('click', () => {
            tracks[currentTrack].params.lfoTarget = b.dataset.target;
            applyParamsToUI();
        });
    });

    function loadSoundPreset(direction) {
        currentPresetIndex = (currentPresetIndex + direction + soundPresets.length) % soundPresets.length;
        const newPreset = soundPresets[currentPresetIndex];
        const oldParams = tracks[currentTrack].params;
        let newMuteGroup = newPreset.muteGroup !== undefined ? newPreset.muteGroup : oldParams.muteGroup;
        tracks[currentTrack].params = { ...defaultParams(), ...newPreset, steps: oldParams.steps, muted: oldParams.muted, muteGroup: newMuteGroup };
        applyParamsToUI();
    }

    document.getElementById('nextPreset').addEventListener('click', () => loadSoundPreset(1));
    document.getElementById('prevPreset').addEventListener('click', () => loadSoundPreset(-1));

    document.getElementById('resetBtn').addEventListener('click', () => {
        const originalParams = initialKit[currentTrack];
        const oldSteps = tracks[currentTrack].params.steps;
        const oldMuted = tracks[currentTrack].params.muted;
        tracks[currentTrack].params = { ...JSON.parse(JSON.stringify(originalParams)), steps: oldSteps, muted: oldMuted };
        applyParamsToUI();
    });

    document.getElementById('audition').addEventListener('click', () => {
        ctx.resume(); 
        const p = tracks[currentTrack].params;
        const tempTrack = { params: {...p, steps: [p.velocity]} };
        triggerVoice(tempTrack, currentTrack, ctx.currentTime, 127);
    });

    document.getElementById('prevTrack').addEventListener('click', () => {
        currentTrack = (currentTrack - 1 + tracks.length) % tracks.length;
        applyParamsToUI();
        highlightSteps();
    });

    document.getElementById('nextTrack').addEventListener('click', () => {
        currentTrack = (currentTrack + 1) % tracks.length;
        applyParamsToUI();
        highlightSteps();
    });

    document.getElementById('muteBtn').addEventListener('click', () => {
        const p = tracks[currentTrack].params;
        p.muted = !p.muted;
        updateTrackDisplay();
    });

    document.getElementById('flamBtn').addEventListener('click', (e) => {
        const p = tracks[currentTrack].params;
        p.flam = !p.flam;
        e.target.classList.toggle('active', p.flam);
    });

    document.getElementById('prevPageBtn').addEventListener('click', () => {
        currentSeqPage = (currentSeqPage - 1 + 8) % 8;
        pageNumDiv.textContent = currentSeqPage + 1;
        highlightSteps();
        updateActiveBarsAndIndicators();
    });
    
    document.getElementById('nextPageBtn').addEventListener('click', () => {
        currentSeqPage = (currentSeqPage + 1) % 8;
        pageNumDiv.textContent = currentSeqPage + 1;
        highlightSteps();
        updateActiveBarsAndIndicators();
    });

    document.getElementById('fxBypassBtn').addEventListener('click', (e) => {
        isFxBypassed = !isFxBypassed;
        e.target.classList.toggle('active', isFxBypassed);
    });


    // Initial Load
    initTracksWithKit();
    renderSeq();

    // Roll interval
    setInterval(() => {
        if (isRolling) {
            const bpm = +document.getElementById('bpm').value;
            const rate = rollRates[rollRate];
            const interval = 60000 / (bpm * (rate / 4));
            triggerVoice(tracks[currentTrack], currentTrack, ctx.currentTime, 127);
        }
    }, 50); // Check frequently for roll state
});
</script>
</body>
</html>
